{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "environmentName": {
            "type": "string"
        },
        "environmentTemplatePath": {
            "type": "string"
        },
        "environmentTemplateRepository": {
            "type": "string"
        },
        "environmentTemplateRevision": {
            "type": "string",
            "defaultValue": ""
        },
        "environmentLocation": {
            "type": "string",
            "defaultValue": "[deployment().location]"
        },
        "deploymentRunner": {
            "type": "string"
        },
        "deploymentIdentity": {
            "type": "string"
        }
    },
    "variables": {
        "ResourceGroupPrefix": "TeamCloud",
        "EnvironmentResourceGroup": "[concat(variables('ResourceGroupPrefix'), '-', parameters('environmentName'))]",
        "DeploymentResourceGroup": "[concat(variables('EnvironmentResourceGroup'), '-', guid(deployment().name))]"
    },
    "resources": [
        {
            "name": "[variables('EnvironmentResourceGroup')]",
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-06-01",
            "location": "[parameters('environmentLocation')]",
            "tags": {},
            "properties": {}
        },
        {
            "name": "[concat(variables('EnvironmentResourceGroup'), '-Prepare')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "resourceGroup": "[variables('EnvironmentResourceGroup')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups', variables('EnvironmentResourceGroup'))]"
            ],
            "properties": {
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                    "deploymentIdentity": {
                        "value": "[parameters('deploymentIdentity')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "deploymentIdentity": {
                            "type": "string"
                        }
                    },
                    "variables": {
                        "RoleDefinitionContributor": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]"
                    },
                    "resources": [
                        {
                            "name": "[guid(resourceGroup().id)]",
                            "type": "Microsoft.Authorization/roleAssignments",
                            "apiVersion": "2018-09-01-preview",
                            "properties": {
                                "roleDefinitionId": "[variables('RoleDefinitionContributor')]",
                                "principalId": "[reference(parameters('deploymentIdentity'), '2018-11-30').principalId]",
                                "scope": "[resourceGroup().id]",
                                "principalType": "ServicePrincipal"
                            }
                        }
                    ],
                    "outputs": {
                        "environmentId": {
                            "type": "string",
                            "value": "[resourceGroup().id]"
                        }
                    }
                }
            }
        },
        {
            "name": "[variables('DeploymentResourceGroup')]",
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-06-01",
            "location": "[parameters('environmentLocation')]",
            "tags": {},
            "properties": {}
        },
        {
            "name": "[concat(variables('EnvironmentResourceGroup'), '-Deploy')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "resourceGroup": "[variables('DeploymentResourceGroup')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups', variables('EnvironmentResourceGroup'))]",
                "[concat(variables('EnvironmentResourceGroup'), '-Prepare')]"
            ],
            "properties": {
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                    "environmentId": {
                        "value": "[reference(concat(variables('EnvironmentResourceGroup'), '-Prepare')).outputs.environmentId.value]"
                    },
                    "environmentLocation": {
                        "value": "[parameters('environmentLocation')]"
                    },
                    "environmentTemplatePath": {
                        "value": "[parameters('environmentTemplatePath')]"
                    },
                    "environmentTemplateRepository": {
                        "value": "[parameters('environmentTemplateRepository')]"
                    },
                    "environmentTemplateRevision": {
                        "value": "[parameters('environmentTemplateRevision')]"
                    },

                    "deploymentRunner": {
                        "value": "[parameters('deploymentRunner')]"
                    },
                    "deploymentIdentity": {
                        "value": "[parameters('deploymentIdentity')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "environmentId": {
                            "type": "string"
                        },
                        "environmentLocation": {
                            "type": "string"
                        },
                        "environmentTemplatePath": {
                            "type": "string"
                        },
                        "environmentTemplateRepository": {
                            "type": "string"
                        },
                        "environmentTemplateRevision": {
                            "type": "string"
                        },
                        "deploymentRunner": {
                            "type": "string"
                        },
                        "deploymentIdentity": {
                            "type": "string"
                        }
                    },
                    "variables": {
                        "deploymentHost": "[concat(guid(parameters('environmentId')), '.', toLower(replace(parameters('environmentLocation'), ' ', '')), '.azurecontainer.io')]",
                        "environmentSegments": "[split(parameters('environmentId'), '/')]"
                    },
                    "resources": [

                        {
                            "name": "[guid(parameters('environmentId'))]",
                            "type": "Microsoft.ContainerInstance/containerGroups",
                            "apiVersion": "2019-12-01",
                            "location": "[resourceGroup().location]",
                            "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                    "[parameters('deploymentIdentity')]": {}
                                }
                            },
                            "properties": {
                                "containers": [
                                    {
                                        "name": "runner",
                                        "properties": {
                                            "command": [],
                                            "image": "[parameters('deploymentRunner')]",
                                            "ports": [
                                                {
                                                    "port": 80 
                                                },
                                                {
                                                    "port": 443
                                                }
                                            ],
                                            "resources": {
                                                "requests": {
                                                    "cpu": 1,
                                                    "memoryInGB": 1
                                                }
                                            },
                                            "environmentVariables": [
                                                {
                                                    "name": "DeploymentId",
                                                    "value": "[guid(parameters('environmentId'))]"
                                                },
                                                {
                                                    "name": "DeploymentHost",
                                                    "value": "[variables('deploymentHost')]"
                                                },
                                                {
                                                    "name": "EnvironmentId",
                                                    "value": "[parameters('environmentId')]"
                                                },
                                                {
                                                    "name": "EnvironmentLocation",
                                                    "value": "[parameters('environmentLocation')]"
                                                },
                                                {
                                                    "name": "EnvironmentTemplateUrl",
                                                    "value": "[uri(concat('http://', variables('deploymentHost')), if (startsWith(parameters('environmentTemplatePath'), '/'), skip(parameters('environmentTemplatePath'), 1), parameters('environmentTemplatePath')))]"
                                                },
                                                {
                                                    "name": "EnvironmentTemplateFile",
                                                    "value": "[uri('file:///mnt/templates/root/', if (startsWith(parameters('environmentTemplatePath'), '/'), skip(parameters('environmentTemplatePath'), 1), parameters('environmentTemplatePath')))]"
                                                },
                                                {
                                                    "name": "EnvironmentResourceGroup",
                                                    "value": "[if(greaterOrEquals(length(variables('environmentSegments')),5), variables('environmentSegments')[4], '')]"
                                                },
                                                {
                                                    "name": "EnvironmentSubscription",
                                                    "value": "[if(greaterOrEquals(length(variables('environmentSegments')),3), variables('environmentSegments')[2], '')]"
                                                }
                                            ],
                                            "volumeMounts": [
                                                {
                                                    "name": "templates",
                                                    "mountPath": "/mnt/templates",
                                                    "readOnly": false
                                                }
                                            ]
                                        }
                                    }
                                ],
                                "osType": "Linux",
                                "restartPolicy": "Never",
                                "ipAddress": {
                                    "type": "Public",
                                    "dnsNameLabel": "[guid(parameters('environmentId'))]",
                                    "ports": [
                                        {
                                            "protocol": "tcp",
                                            "port": 80
                                        },
                                        {
                                            "protocol": "tcp",
                                            "port": 443
                                        }                                    
                                    ]
                                },
                                "volumes": [
                                    {

                                        "name": "templates",
                                        "gitRepo": {
                                            "directory": "root",
                                            "repository": "[parameters('environmentTemplateRepository')]",
                                            "revision": "[parameters('environmentTemplateRevision')]"
                                        }
                                    }
                                ]
                            }
                        }
                    ],
                    "outputs": {

                    }
                }
            }
        }
    ]
}
